CREATE DATABASE Oktatas
DEFAULT charset utf8
COLLATE utf8_hungarian_ci;

CREATE TABLE Felhasznalok(
	FelhasznaloID int PRIMARY KEY AUTO_INCREMENT,
    Nev varchar(100) NOT NULL,
    Email varchar(150) NOT NULL UNIQUE,
    Szerep ENUM ("diak", "tanar", "admin") NOT NULL,
    RegisztracioDatuma datetime NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE Kurzusok(
	KurzusID int AUTO_INCREMENT PRIMARY KEY,
    Cim varchar(200) NOT NULL,
    Leiras text,
    TanarID int NOT NULL,
    Letrehozva datetime DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_kurzus_felhTanar FOREIGN KEY (TanarID) REFERENCES felhasznalok (FelhasznaloID	)
    ON DELETE RESTRICT
    ON UPDATE CASCADE
);

CREATE TABLE Leckek(
	LeckeID int PRIMARY KEY AUTO_INCREMENT,
    KurzusID int NOT NULL,
    Cim varchar(200) NOT NULL,
    Tartalom text,
    sorszam int NOT NULL,
    CONSTRAINT fk_lecke_kurzus FOREIGN KEY (KurzusID) REFERENCES kurzusok (kurzusID)
    ON DELETE CASCADE
    ON UPDATE CASCADE
);

CREATE TABLE Beiratkozasok(
	BeiratkozasID int AUTO_INCREMENT PRIMARY KEY,
    FelhasznaloID int NOT NULL,
    KurzusID int NOT NULL,
    Beiratkozva datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_felh_beiratk FOREIGN KEY (FelhasznaloID) REFERENCES felhasznalok (FelhasznaloID)
    ON DELETE CASCADE
    ON UPDATE CASCADE,
    CONSTRAINT fk_beiratk_kurzus FOREIGN KEY (KurzusID) REFERENCES kurzusok (KurzusID)
    ON DELETE CASCADE
    ON UPDATE CASCADE,
    CONSTRAINT uq_beiratk UNIQUE (FelhasznaloID, KurzusID)
);

CREATE TABLE Feladatok(
	FeladatID int AUTO_INCREMENT PRIMARY KEY,
    LeckeID int NOT NULL,
    Cim varchar(200) NOT NULL,
    MaxPont int NOT NULL,
    Hatarido datetime,
    CONSTRAINT fk_feladat_lecke FOREIGN KEY (LeckeID) REFERENCES leckek (LeckeID)
    ON DELETE CASCADE
    ON UPDATE CASCADE,
    CONSTRAINT chk_maxPont CHECK (MaxPont > 0)
);

CREATE TABLE Beadasok(
	BeadasID int PRIMARY KEY AUTO_INCREMENT,
    FeladatID int NOT NULL,
    FelhasznaloID int NOT NULL,
    Beadva datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
    Pont int,
    UtolsoModositas datetime,
    CONSTRAINT fk_feladat_beadas FOREIGN KEY (FeladatID) REFERENCES Feladatok (FeladatID)
    ON DELETE CASCADE
    ON UPDATE CASCADE,
    CONSTRAINT fk_felh_beadas FOREIGN KEY (FelhasznaloID) REFERENCES felhasznalok (FelhasznaloID)
);

CREATE TABLE Forumtemak(
	TemaID int AUTO_INCREMENT PRIMARY KEY,
    KurzusID int NOT NULL,
    FelhasznaloID int NOT NULL,
    Cim varchar(200) NOT NULL,
    Letrehozva datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_kurzus_forumtema FOREIGN KEY (KurzusID) REFERENCES kurzusok (KurzusID)
    ON DELETE CASCADE
    ON UPDATE CASCADE,
    CONSTRAINT fk_felh_forumtema FOREIGN KEY (FelhasznaloID) REFERENCES felhasznalok (felhasznaloID)
    ON DELETE CASCADE
    ON UPDATE CASCADE
);

CREATE TABLE Forumhozzaszolasok(
	HozzaszolasID int PRIMARY KEY AUTO_INCREMENT,
    TemaID int NOT NULL,
    FelhasznaloID int NOT NULL,
    Tartalom text NOT NULL,
    Letrehozva datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_tema_hozzaszolas FOREIGN KEY (TemaID) REFERENCES Forumtemak (TemaID)
    ON DELETE CASCADE
    ON UPDATE CASCADE,
    CONSTRAINT fk_flh_hozzaszolas FOREIGN KEY (FelhasznaloID) REFERENCES felhasznalok (felhasznaloID)
    ON DELETE CASCADE
    ON UPDATE CASCADE
);

--Lekérdezés 1:
SELECT kurzusok.KurzusID, kurzusok.Cim, COUNT(beiratkozasok.FelhasznaloID) AS diakokSzama FROM beiratkozasok, kurzusok
WHERE kurzusok.KurzusID=beiratkozasok.KurzusID
GROUP BY kurzusok.KurzusID, kurzusok.Cim
HAVING diakokSzama>=2

--Lekérdezés 1, második megoldás:
SELECT k.KurzusID, k.Cim, COUNT(b.FelhasznaloID) FROM kurzusok k JOIN beiratkozasok b ON k.KurzusID=b.KurzusID
GROUP BY k.KurzusID, k.Cim
HAVING COUNT(b.FelhasznaloID)>=2

--Lekérdezés 2

--Lekérdezés 2 - másik megoldás:

--Lekérdezés 3:
SELECT kurzusok.Cim AS kurzusNev, COUNT(beadasok.BeadasID) AS összesBeadas, AVG(beadasok.Pont) as atlagPontszam, MAX(beadasok.Beadva) as utolsoBeadas
FROM kurzusok
LEFT JOIN leckek ON kurzusok.KurzusID=leckek.KurzusID
LEFT JOIN feladatok ON leckek.LeckeID=feladatok.LeckeID
LEFT JOIN beadasok ON feladatok.FeladatID=beadasok.FeladatID
GROUP BY kurzusok.Cim

--Lekérdezés 4:
SELECT kurzusok.KurzusID, kurzusok.Cim, COUNT(forumhozzaszolasok.HozzaszolasID) as hozzászólásokSzáma
FROM kurzusok
LEFT JOIN forumtemak ON kurzusok.KurzusID=forumtemak.KurzusID
LEFT JOIN forumhozzaszolasok ON forumtemak.TemaID=forumhozzaszolasok.TemaID
GROUP BY kurzusok.KurzusID, kurzusok.Cim
ORDER BY COUNT(forumhozzaszolasok.HozzaszolasID) DESC

--Nézetek
--1
CREATE VIEW kurzusleckeÖsszegzés AS
SELECT felhasznalok.FelhasznaloID AS TanarNev, kurzusok.Cim AS KurzusNeve, COUNT(leckek.LeckeID) AS LeckekSzama
FROM kurzusok
JOIN felhasznalok ON kurzusok.TanarID=felhasznalok.FelhasznaloID
LEFT JOIN leckek ON kurzusok.KurzusID=leckek.KurzusID
GROUP BY felhasznalok.Nev, kurzusok.Cim

--2
CREATE VIEW tanariÖsszegzés AS
SELECT felhasznalok.Nev AS TanarNeve, COUNT(DISTINCT kurzusok.KurzusID) AS KurzusokSzama, COUNT(beadasok.BeadasID) AS ÖsszBeadas
FROM felhasznalok
JOIN kurzusok ON felhasznalok.FelhasznaloID=kurzusok.TanarID
LEFT JOIN leckek ON kurzusok.KurzusID=leckek.LeckeID
LEFT JOIN feladatok ON leckek.LeckeID=feladatok.LeckeID
LEFT JOIN beadasok ON feladatok.FeladatID=beadasok.FeladatID
WHERE felhasznalok.Szerep="tanar"
GROUP BY felhasznalok.Nev

